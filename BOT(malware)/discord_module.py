import requests
import time
from custom_logger import CustomLogger

class DiscordHandler:
    def __init__(self, webhook_url):
        self.webhook_url = webhook_url
        log_file_path = "Rklog.log"  # Replace this with your desired log file path
        global logger 
        logger = CustomLogger(log_file_path)

    def _send_request(self, payload):
        retries = 3  # Number of retry attempts
        for _ in range(retries):
            try:
                response = requests.post(self.webhook_url, json=payload)
                if response.status_code == 204:
                    return  # Request successful
            except requests.exceptions.RequestException as e:
                print(f"Error: {e}")
                logger.log(f"Error: {e}")
            time.sleep(5)  # Wait for 5 seconds before retrying
        print("Failed to send message to Discord after multiple attempts.")
        logger.log("Failed to send message to Discord after multiple attempts.")


    def send_text_message(self, content, username=None, avatar_url=None):
        payload = {
            "content": content,
            "username": username,
            "avatar_url": avatar_url
        }
        self._send_request(payload)
        logger.log(payload)

    def send_embed(self, embed, username=None, avatar_url=None):
        payload = {
            "embeds": [embed],
            "username": username,
            "avatar_url": avatar_url
        }
        self._send_request(payload)
        logger.log(payload)

    def send_file(self, file_path, content=None, username=None, avatar_url=None):
        files = {"file": open(file_path, "rb")}
        payload = {
            "content": content,
            "username": username,
            "avatar_url": avatar_url
        }
        response = requests.post(self.webhook_url, data=payload, files=files)
        logger.log(f"file send : {file_path}")
        if response.status_code != 200:
            print(f"Failed to send file. Status code: {response.status_code}")
            logger.log(f"Failed to send file. Status code: {response.status_code}")
        return response

    def send_error_report(self, error_message, username=None, avatar_url=None):
        payload = {
            "content": f"Error Report: {error_message}",
            "username": username,
            "avatar_url": avatar_url
        }
        self._send_request(payload)
        logger.log(payload)
        

if __name__ == "__main__":
    # Example usage of the DiscordHandler module
    webhook_url = "YOUR_WEBHOOK_URL"
    discord_handler = DiscordHandler(webhook_url)
    discord_handler.send_text_message("Hello, Discord!")
    discord_handler.send_embed({
        "title": "Embed Title",
        "description": "This is an example embed message.",
        "color": 0x00ff00
    })
    discord_handler.send_file("example.txt", "Check out this file!")
    discord_handler.send_error_report("Something went wrong!")
